<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>設備叫修單</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #00B900; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 25px;}
        .form-group { margin-bottom: 20px; }
        .form-group-title { font-weight: bold; font-size: 1.1em; color: #333; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: #555; }
        input[type="text"], textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        textarea { height: 120px; resize: vertical; }
        button { width: 100%; background-color: #00c300; color: white; padding: 15px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .user-info { text-align: center; margin-bottom: 25px; padding: 10px; background-color: #eef; border-radius: 4px; font-size: 14px; }
        #loading, #result { text-align: center; padding: 20px; font-weight: bold; }
        #result.success { color: green; }
        #result.error { color: red; }
        label small { font-weight: normal; color: #999; }
    </style>
</head>
<body>
<div class="container">
    <h1>設備叫修單</h1>
    <div id="loading">載入中，請稍候...</div>
    <div id="result" style="display:none;"></div>

    <form id="repairForm" style="display:none;">
        <div class="user-info">
            你好，<span id="displayName"></span>
        </div>
        
        <input type="hidden" id="userId" name="userId">
        <input type="hidden" id="lineDisplayName" name="lineDisplayName">
        <input type="hidden" id="groupId" name="groupId">

        <div class="form-group">
            <label for="vesselMachine">事發船機 *</label>
            <input type="text" id="vesselMachine" name="vesselMachine" required>
        </div>
        <div class="form-group">
            <label for="location">位置(工區) *</label>
            <input type="text" id="location" name="location" required>
        </div>

        <div class="form-group-title">待修機具</div>

        <div class="form-group">
            <label for="equipmentName">名稱 *</label>
            <input type="text" id="equipmentName" name="equipmentName" required>
        </div>
        <div class="form-group">
            <label for="assetNumber">資產編號 <small>(選填)</small></label>
            <input type="text" id="assetNumber" name="assetNumber">
        </div>
        <div class="form-group">
            <label for="problemDescription">狀況描述 *</label>
            <textarea id="problemDescription" name="problemDescription" required></textarea>
        </div>

        <button type="submit" id="submitButton">提交報修單</button>
    </form>
</div>

<script>
    // #################################################################
    // ## 【重要設定 1】請手動貼上您 Google Apps Script 的 API 網址 ##
    // #################################################################
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw9EEIWITaMmz87FrvyqSBU6SITTvLeE_89Kj6GtCHjCkjgNAvMaobNdS47qTOOfq98_w/exec";


    window.onload = function() {
        // #################################################################
        // ## 【重要設定 2】請手動貼上您 LINE Login 頻道中的 LIFF ID ##
        // #################################################################
        liff.init({ liffId: "2008002175-Zoa58OAJ" })
            .then(() => liff.getProfile())
            .then(profile => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('repairForm').style.display = 'block';
                document.getElementById('displayName').innerText = profile.displayName;
                
                document.getElementById('userId').value = profile.userId;
                document.getElementById('lineDisplayName').value = profile.displayName;
                const context = liff.getContext();
                const targetId = (context && context.type !== 'none') ? (context.type === 'group' ? context.groupId : context.roomId) : profile.userId;
                document.getElementById('groupId').value = targetId;
            })
            .catch(err => {
                console.error("LIFF 初始化失敗", err);
                document.getElementById('loading').style.display = 'none';
                const resultDiv = document.getElementById('result');
                resultDiv.innerText = 'LIFF 應用程式初始化失敗，請確認 LIFF ID 是否正確。';
                resultDiv.className = 'error';
                resultDiv.style.display = 'block';
            });
    };
    
    document.getElementById('repairForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const submitButton = document.getElementById('submitButton');
        submitButton.disabled = true;
        submitButton.innerText = '傳送中...';
        
        const formData = {
            userId: document.getElementById('userId').value,
            lineDisplayName: document.getElementById('lineDisplayName').value,
            groupId: document.getElementById('groupId').value,
            vesselMachine: document.getElementById('vesselMachine').value,
            location: document.getElementById('location').value,
            equipmentName: document.getElementById('equipmentName').value,
            assetNumber: document.getElementById('assetNumber').value,
            problemDescription: document.getElementById('problemDescription').value
        };
        
        const payload = {
            source: 'liff_form',
            formData: formData
        };
        
        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: { 'Content-Type': 'application/json' },
            mode: 'no-cors' // 使用 no-cors 模式來避免跨域問題
        })
        .then(() => {
             const resultDiv = document.getElementById('result');
             // 因為 no-cors 模式無法讀取後端的回應，我們直接顯示通用成功訊息
             resultDiv.innerText = "報修請求已成功送出！此視窗將自動關閉。";
             resultDiv.className = 'success';
             resultDiv.style.display = 'block';
             document.getElementById('repairForm').style.display = 'none';
             setTimeout(() => { if (liff.isInClient()) liff.closeWindow(); }, 3000);
        })
        .catch(error => {
            console.error('Submit Error:', error);
            const resultDiv = document.getElementById('result');
            resultDiv.innerText = '提交失敗，發生網路錯誤。請稍後再試。';
            resultDiv.className = 'error';
            resultDiv.style.display = 'block';
            submitButton.disabled = false;
            submitButton.innerText = '重新提交';
        });
    });
</script>

</body>
</html>